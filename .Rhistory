tidyr::pivot_longer(-geoid, names_to = "day", values_to = "prcp") %>%
mutate(day = as.numeric(gsub("V","", day)))
data
ggplot(data, aes(x = day, y = prcp))  +
geom_line() +
labs(x = "Date", y = "Mean Rainfall",
title = paste("GEOID: ", data$geoid[1])) +
theme_bw()
file = '/Users/mjohnson/Downloads/MCD12Q1.006.nc'
rcl = read.csv("inst/modis_lc.csv") %>%
dplyr::select(from = Class, to = short)
system.time({
# Build Weight Grid
w  = weighting_grid(file, AOI, "geoid")
# Intersect, and relclassify
lc = execute_zonal_cat(file, w, rcl)
})
# Intersect, and relclassify
lc = execute_zonal_cat(file, AOI, "geoid", rcl = rcl)
file = '/Users/mjohnson/github/zonal/depreciate/2019-01-01.tif'
rcl = read.csv("inst/modis_lc.csv") %>%
dplyr::select(from = Class, to = short)
system.time({
lc = execute_zonal_cat(file, AOI, "geoid", rcl = rcl)
})
to_plot = merge(AOI, lc)
ggplot(to_plot) +
geom_sf(aes(fill = percentage), color = "transparent") +
scale_fill_gradient2() +
geom_sf(data = sf::st_union(AOI), fill = "transparent") +
facet_wrap(~value) +
theme_minimal()
ggplot(to_plot) +
geom_sf(aes(fill = percentage), color = "transparent") +
scale_fill_gradient2() +
geom_sf(data = sf::st_union(AOI), fill = "transparent") +
facet_wrap(~value) +
theme_void()
ggplot(to_plot) +
geom_sf(aes(fill = percentage), color = "transparent") +
scale_fill_gradient2() +
geom_sf(data = sf::st_union(AOI), fill = "transparent") +
facet_wrap(~value) +
theme_void() +
theme(legend.position = "bottom")
pkgdown::build_site()
devtools::load_all(".")
library(devtools)
document()
check()
devtools::load_all(".")
check()
check()
library(zonal)
library(ggplot2)
library(dplyr)
library(sf)
read.csv("modis_lc.csv")
file = 'pet_2020.nc'
(s = terra::rast(file))
geom <- st_make_valid(read_sf('ngen_01a-4.gpkg', "catchments"))
file = '2019-01-01.tif'
(r = terra::rast(file))
devtools::load_all(".")
devtools::load_all(".")
devtools::document()
devtools::load_all()
devtools::check()
rcompendium::add_dependencies()
rcompendium::add_dependencies_badge()
rcompendium::add_r_depend()
knitr::knit("README.Rmd")
file <- 'to_build/pr_2020.nc'
AOI  <- AOI::aoi_get(state = "south", county = "all")
library(AOI)
AOI  <- AOI::aoi_get(state = "south", county = "all")
install.packages("USAboundariesData", repos = "http://packages.ropensci.org", type = "source")
devtools::install_github("ropensci/USAboundaries")
devtools::install_github("ropensci/USAboundariesData")
AOI  <- AOI::aoi_get(state = "south", county = "all")
AOI  <- AOI::aoi_get(state = "south", county = "all")
# Build Weight Grid
w        = weighting_grid(file, AOI, "geoid")
getwd()
list.files()
file <- 'to_build/pet_2020.nc'
system.time({
# Build Weight Grid
w        = weighting_grid(file, AOI, "geoid")
# Intersect
pr_zone = execute_zonal(file, w = w)
})
file <- 'to_build/pr_2020.nc'
file <- 'to_build/pr_2020.nc'
AOI  <- AOI::aoi_get(state = "south", county = "all")
system.time({
# Build Weight Grid
w        = weighting_grid(file, AOI, "geoid")
# Intersect
pr_zone = execute_zonal(file, w = w)
})
# Plot Day with the maximum single county max rainfall.
n = colnames(pr_zone)[which(pr_zone[,-1] == max(pr_zone[,-1]), arr.ind = TRUE)[2] + 1]
plot(merge(AOI, pr_zone)[n], border = NA)
x = merge(AOI, pr_zone)[n]
x
n
ggplot() +
geom_sf(x, aes(fill = !!n))
ggplot() +
geom_sf(data = x, aes(fill = !!n))
ggplot() +
geom_sf(data = x, aes(fill = get(n)))
ggplot() +
geom_sf(data = x, aes(fill = get(n), color = NA)) +
scale_fill_viridis_c()
ggplot() +
geom_sf(data = x, aes(fill = get(n), color = NA)) +
scale_fill_viridis_c()
ggplot() +
geom_sf(data = x, aes(fill = get(n), color = "NA")) +
scale_fill_viridis_c()
ggplot() +
geom_sf(data = x, aes(fill = get(n), color = NA))
ggplot() +
geom_sf(data = x, aes(fill = get(n), color = "transparent")) +
scale_fill_viridis_c()
ggplot() +
geom_sf(data = x, aes(fill = get(n)), color = NA) +
scale_fill_viridis_c()
ggplot() +
geom_sf(data = x, aes(fill = get(n)), color = NA) +
scale_fill_viridis_c() +
theme_void()
ggplot() +
geom_sf(data = x, aes(fill = get(n)), color = NA) +
scale_fill_viridis_c() +
theme_void() +
labs(fill = "PR")
ggplot() +
geom_sf(data = x, aes(fill = get(n)), color = NA) +
scale_fill_viridis_c() +
theme_void() +
labs(fill = "PR (mm)")
pr_zone
# Plot Day with the maximum county wide rainfall
n2 = names(which.max(colSums(dplyr::select(pr_zone, -geoid))))
x = merge(AOI, pr_zone)[n2]
ggplot() +
geom_sf(data = x, aes(fill = get(n2)), color = NA) +
scale_fill_viridis_c() +
theme_void() +
labs(fill = "PR (mm)")
x = merge(AOI, pr_zone)
x
x = merge(AOI, pr_zone)
# Plot Day with the maximum single county max rainfall.
n = colnames(pr_zone)[which(pr_zone[,-1] == max(pr_zone[,-1]), arr.ind = TRUE)[2] + 1]
ggplot() +
geom_sf(data = x, aes(fill = get(n)), color = NA) +
scale_fill_viridis_c() +
theme_void() +
labs(fill = "PR (mm)")
# Plot Day with the maximum county wide rainfall
n2 = names(which.max(colSums(dplyr::select(pr_zone, -geoid))))
# Plot Day with the maximum county wide rainfall
n2 = names(which.max(colSums(dplyr::select(pr_zone, -geoid))))
ggplot() +
geom_sf(data = x, aes(fill = get(n2)), color = NA) +
scale_fill_viridis_c() +
theme_void() +
labs(fill = "PR (mm)")
data = pr_zone %>%
slice_max(rowSums(dplyr::select(., -geoid))) %>%
tidyr::pivot_longer(-geoid, names_to = "day", values_to = "prcp") %>%
mutate(day = as.numeric(gsub("V","", day)))
head(data)
ggplot(data, aes(x = day, y = prcp))  +
geom_line() +
labs(x = "Date", y = "Mean Rainfall",
title = paste("GEOID: ", data$geoid[1])) +
theme_bw()
rcl = read.csv("modis_lc.csv") %>%
dplyr::select(from = Class, to = short)
library(zonal)
library(sf)
library(dplyr)
library(ggplot2)
file <- 'pr_2020.nc'
AOI  <- AOI::aoi_get(state = "south", county = "all")
system.time({
# Build Weight Grid
w        = weighting_grid(file, AOI, "geoid")
# Intersect
pr_zone = execute_zonal(file, w = w)
})
library(tidyr)
rcompendium::add_dependencies()
rcompendium::add_dependencies_badge()
rcompendium::get_all_dependencies()
rcompendium::get_all_dependencies()
knitr::knit("README.Rmd")
rcompendium::get_all_dependencies()
rcompendium::get_all_dependencies
library(renv)
renv::dependencies()
renv::dependencies()
#rcompendium::get_all_dependencies()
renv::dependencies() %>%
filter(!grepl("README", Source))
#rcompendium::get_all_dependencies()
renv::dependencies() %>%
filter(!grepl("README", Source)) %>%
distinct(Package)
#rcompendium::get_all_dependencies()
renv::dependencies() %>%
filter(!grepl("README|pkgdown", Source)) %>%
distinct(Package)
renv::dependencies() %>%
filter(!grepl("README|pkgdown", Source))
#rcompendium::get_all_dependencies()
renv::dependencies() %>%
filter(!grepl("README|pkgdown|vignettes", Source)) %>%
distinct(Package)
lapply(renv::dependencies('data.table'))
renv::dependencies('data.table')
rcompendium::get_all_dependencies('.')
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>",
fig.path = "man/figures/README-",
out.width = "100%",
warning = FALSE,
message = FALSE
)
library(zonal)
library(dplyr)
library(tidyr)
library(ggplot2)
file <- 'to_build/pr_2020.nc'
AOI  <- AOI::aoi_get(state = "south", county = "all")
system.time({
# Build Weight Grid
w        = weighting_grid(file, AOI, "geoid")
# Intersect
pr_zone = execute_zonal(file, w = w)
})
# PET zone: Counties, time slices/ID
dim(pr_zone)
x = merge(AOI, pr_zone)
# Plot Day with the maximum single county max rainfall.
n = colnames(pr_zone)[which(pr_zone[,-1] == max(pr_zone[,-1]), arr.ind = TRUE)[2] + 1]
ggplot() +
geom_sf(data = x, aes(fill = get(n)), color = NA) +
scale_fill_viridis_c() +
theme_void() +
labs(fill = "PR (mm)")
# Plot Day with the maximum county wide rainfall
n2 = names(which.max(colSums(dplyr::select(pr_zone, -geoid))))
ggplot() +
geom_sf(data = x, aes(fill = get(n2)), color = NA) +
scale_fill_viridis_c() +
theme_void() +
labs(fill = "PR (mm)")
data = pr_zone %>%
slice_max(rowSums(select(., -geoid))) %>%
pivot_longer(-geoid, names_to = "day", values_to = "prcp") %>%
mutate(day = as.numeric(gsub("V","", day)))
head(data)
ggplot(data, aes(x = day, y = prcp))  +
geom_line() +
labs(x = "Date", y = "Mean Rainfall",
title = paste("GEOID: ", data$geoid[1])) +
theme_bw()
file = 'to_build/2019-01-01.tif'
rcl = read.csv("to_build//modis_lc.csv") %>%
select(from = Class, to = short)
system.time({
lc = execute_zonal_cat(file, AOI, "geoid", rcl = rcl)
})
to_plot = merge(AOI, lc)
ggplot(to_plot) +
geom_sf(aes(fill = percentage), color = "transparent") +
scale_fill_gradient2() +
geom_sf(data = sf::st_union(AOI), fill = "transparent") +
facet_wrap(~value) +
theme_void() +
theme(legend.position = "bottom")
rcompendium::get_all_dependencies()
# rcompendium::add_dependencies()
# rcompendium::add_dependencies_badge()
# rcompendium::add_r_depend()
knitr::knit("README.Rmd")
library(knitr)
fs::file_copy("to_build/01_weight_creation.Rmd", 'vignettes/01_weight_creation.Rmd.orig', overwrite = TRUE)
knit("vignettes/01_weight_creation.Rmd.orig", "vignettes/01_weight_creation.Rmd")
library(exactextractr)
fs::file_copy("to_build/01_weight_creation.Rmd", 'vignettes/01_weight_creation.Rmd.orig', overwrite = TRUE)
fs::file_copy("to_build/01_weight_creation.Rmd", 'vignettes/01_weight_creation.Rmd.orig', overwrite = TRUE)
getwd()
fs::file_copy("to_build/01_weight_creation.Rmd",
'vignettes/01_weight_creation.Rmd.orig',
overwrite = TRUE)
getwd()
fs::file_copy("../to_build/01_weight_creation.Rmd",
'01_weight_creation.Rmd.orig',
overwrite = TRUE)
knit("vignettes/01_weight_creation.Rmd.orig", "vignettes/01_weight_creation.Rmd")
library(knitr)
fs::file_copy("../to_build/01_weight_creation.Rmd",
'01_weight_creation.Rmd.orig',
overwrite = TRUE)
knit("vignettes/01_weight_creation.Rmd.orig", "vignettes/01_weight_creation.Rmd")
getwd()
getwd()
devtools::load_all("~/github/zonal")
getwd()
devtools::load_all("~/github/zonal")
getwd()
getwd()
library(knitr)
fs::file_copy("to_build/01_weight_creation.Rmd",
'vignettes/01_weight_creation.Rmd.orig',
overwrite = TRUE)
knit("vignettes/01_weight_creation.Rmd.orig", "vignettes/01_weight_creation.Rmd")
library(intersectr)
knit("vignettes/01_weight_creation.Rmd.orig", "vignettes/01_weight_creation.Rmd")
library(knitr)
fs::file_copy("to_build/01_weight_creation.Rmd",
'vignettes/01_weight_creation.Rmd.orig',
overwrite = TRUE)
knit("vignettes/01_weight_creation.Rmd.orig", "vignettes/01_weight_creation.Rmd")
getwd()
setwd("/Users/mjohnson/github/zonal/")
fs::file_copy("to_build/01_weight_creation.Rmd",
'vignettes/01_weight_creation.Rmd.orig',
overwrite = TRUE)
knit("vignettes/01_weight_creation.Rmd.orig", "vignettes/01_weight_creation.Rmd")
knit("to_build/01_weight_creation.Rmd", "vignettes/01_weight_creation.Rmd")
files = list.files(".", ".png", full.names = TRUE)
files
fs::file_move(files, paste0('vignettes/', basename(files)))
knit("vignettes/02_intersections.Rmd", "vignettes/02_intersections.Rmd")
knit("to_build/02_intersections.Rmd", "vignettes/02_intersections.Rmd")
knit("to_build/02_intersections.Rmd", "vignettes/02_intersections.Rmd")
library(dplyr)
library(dplyr)
library(data.table)
library(dplyr)
library(data.table)
library(RNetCDF)
library(sf)
library(ncmeta)
library(intersectr)
library(zonal)
library(terra)
library(ggplot2)
knitr::opts_chunk$set(
out.width = "100%",
fig.width = 7,
fig.height = 4, dpi = 150, fig.path = "i-",
message = FALSE, warning = FALSE, error = FALSE
)
intersectr_prep = function(file, geom, ID, variable){
nc_coord_vars <- nc_coord_var(file)
nc_coord_vars <- filter(nc_coord_vars, variable == !!variable)
nc       <- open.nc(file)
X_coords <- var.get.nc(nc, nc_coord_vars$X, unpack = TRUE)
Y_coords <- var.get.nc(nc, nc_coord_vars$Y, unpack = TRUE)
nc_prj <- nc_gm_to_prj(nc_grid_mapping_atts(file))
cell_geometry = create_cell_geometry(X_coords = X_coords,
Y_coords = Y_coords,
prj = nc_prj,
geom = geom,
buffer_dist = 0.1, # Degrees
regularize = TRUE)
data_source_cells <- st_sf(dplyr::select(cell_geometry, grid_ids))
target_polygons   <- st_sf(dplyr::select(geom, !!ID))
st_agr(data_source_cells) <- "constant"
st_agr(target_polygons)   <- "constant"
area_weights = calculate_area_intersection_weights(data_source_cells, target_polygons, allow_lonlat = TRUE)
return(list(grid = cell_geometry, w = area_weights, x = nc_coord_vars$X, y = nc_coord_vars$Y, t = nc_coord_vars$T))
}
intersectr_prep
exactrextract_process = function(file, geom, ID){
R.utils::withTimeout(
exactextractr::exact_extract(raster::stack(file),
geom,
stack_apply = TRUE,
fun = "mean",
append_cols = ID,
progress = FALSE),
timeout = 180, onTimeout = "silent")
}
library(zonal)
file = 'pet_2020.nc'
(s = terra::rast(file))
geom <- read_sf('ngen_01a-4.gpkg', "catchments") %>%
st_make_valid()
glimpse(geom)
int_time_huc01 = system.time({
intersectr_input = intersectr_prep(file, geom, ID = "comid", variable = 'potential_evapotranspiration')
})
huc01_bnch <- bench::mark(
iterations = 1, check = FALSE, time_unit = 's',
intersectr_staged_weights = execute_intersection(nc_file = file,
variable_name = 'potential_evapotranspiration',
intersection_weights = intersectr_input$w,
cell_geometry = intersectr_input$grid,
x_var = intersectr_input$x,
y_var = intersectr_input$y,
t_var = intersectr_input$t,
start_datetime = NULL,
end_datetime = NULL),
exactextractr            = exactrextract_process(file, geom, "comid"),
zonal_full               = execute_zonal(file, geom, "comid"),
zonal_staged_weights     = execute_zonal(file, w = zonal_w)
)
install.packages('R.utils')
huc01_bnch <- bench::mark(
iterations = 1, check = FALSE, time_unit = 's',
intersectr_staged_weights = execute_intersection(nc_file = file,
variable_name = 'potential_evapotranspiration',
intersection_weights = intersectr_input$w,
cell_geometry = intersectr_input$grid,
x_var = intersectr_input$x,
y_var = intersectr_input$y,
t_var = intersectr_input$t,
start_datetime = NULL,
end_datetime = NULL),
exactextractr            = exactrextract_process(file, geom, "comid"),
zonal_full               = execute_zonal(file, geom, "comid"),
zonal_staged_weights     = execute_zonal(file, w = zonal_w)
)
library('ncdf4')
huc01_bnch <- bench::mark(
iterations = 1, check = FALSE, time_unit = 's',
intersectr_staged_weights = execute_intersection(nc_file = file,
variable_name = 'potential_evapotranspiration',
intersection_weights = intersectr_input$w,
cell_geometry = intersectr_input$grid,
x_var = intersectr_input$x,
y_var = intersectr_input$y,
t_var = intersectr_input$t,
start_datetime = NULL,
end_datetime = NULL),
exactextractr            = exactrextract_process(file, geom, "comid"),
zonal_full               = execute_zonal(file, geom, "comid"),
zonal_staged_weights     = execute_zonal(file, w = zonal_w)
)
zonal_time_huc01 = system.time({
zonal_w = weighting_grid(file, geom, ID = "comid")
})
zonal_w
zonal_w
huc01_bnch <- bench::mark(
iterations = 1, check = FALSE, time_unit = 's',
intersectr_staged_weights = execute_intersection(nc_file = file,
variable_name = 'potential_evapotranspiration',
intersection_weights = intersectr_input$w,
cell_geometry = intersectr_input$grid,
x_var = intersectr_input$x,
y_var = intersectr_input$y,
t_var = intersectr_input$t,
start_datetime = NULL,
end_datetime = NULL),
exactextractr            = exactrextract_process(file, geom, "comid"),
zonal_full               = execute_zonal(file, geom, "comid"),
zonal_staged_weights     = execute_zonal(file, w = zonal_w)
)
knit("to_build/02_intersections.Rmd", "vignettes/02_intersections.Rmd")
library(knitr)
setwd("/Users/mjohnson/github/zonal/")
knit("to_build/02_intersections.Rmd", "vignettes/02_intersections.Rmd")
knit("to_build/03_categorical.Rmd", "vignettes/03_categorical.Rmd")
files = list.files(".", ".png", full.names = TRUE)
fs::file_move(files, paste0('vignettes/', basename(files)))
pkgdown::build_site()
devtools::load_all(".")
devtools::load_all(".")
terra::rast('/Users/mjohnson/github/zonal/to_build/soilproperties_CONUS_FullRouting.nc')
t = terra::rast('/Users/mjohnson/github/zonal/to_build/soilproperties_CONUS_FullRouting.nc')
names(t)
geom
geom <- read_sf('ngen_01a-4.gpkg', "catchments") %>%
st_make_valid()
geom <- read_sf('to_build/ngen_01a-4.gpkg', "catchments") %>%
st_make_valid()
library(dplyr)
geom <- read_sf('to_build/ngen_01a-4.gpkg', "catchments") %>%
st_make_valid()
library(sf)
geom <- read_sf('to_build/ngen_01a-4.gpkg', "catchments") %>%
st_make_valid()
file = '/Users/mjohnson/github/zonal/to_build/soilproperties_CONUS_FullRouting.nc'
zonal_w = weighting_grid(file, geom, ID = "comid")
zonal_w
geom
zonal_w = weighting_grid(file, geom, ID = "comid")
file
geom
ID = 'comid'
if(grepl("raster|character", class(file), ignore.case = TRUE)){ file = file[[1]] }
r    = suppressWarnings({ terra::rast(file)[[1]] })
r
raster(file)
raster::raster(file)
library(raster)
raster("to_build/soilproperties_CONUS_FullRouting.nc")
r = raster("to_build/soilproperties_CONUS_FullRouting.nc")
res(r) = c(1000, 1000)
r
