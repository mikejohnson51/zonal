<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NWM Channel Routing Application â€¢ zonal</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="NWM Channel Routing Application">
<meta property="og:description" content="zonal">
<meta property="og:image" content="/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">zonal</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_weight_creation.html">Weight Maps</a>
    </li>
    <li>
      <a href="../articles/02_intersections.html">Zonal Statistics</a>
    </li>
    <li>
      <a href="../articles/03_categorical.html">Categorical Data</a>
    </li>
    <li>
      <a href="../articles/04_nwm_channel.html">NWM Channel Routing Application</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mikejohnson51/zonal/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="04_nwm_channel_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>NWM Channel Routing Application</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mikejohnson51/zonal/blob/master/vignettes/04_nwm_channel.Rmd"><code>vignettes/04_nwm_channel.Rmd</code></a></small>
      <div class="hidden name"><code>04_nwm_channel.Rmd</code></div>

    </div>

    
    
<p>The purpose here is to demonstrate a real world application of <code>zonal</code> to summarize the NWM channel routing parmaters to a in-development hydrofabric.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">zonal</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">paint</span><span class="op">)</span></code></pre></div>
<div id="define-aggregations-geometries-and-geogrid" class="section level3">
<h3 class="hasAnchor">
<a href="#define-aggregations-geometries-and-geogrid" class="anchor"></a>Define Aggregations Geometries and Geogrid</h3>
<p>Here we are using a version of the <code>ngen</code> hydrofabric:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">geom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">'hydrofabric.gpkg'</span>, <span class="st">"catchments"</span><span class="op">)</span>
<span class="fu">paint</span><span class="op">(</span><span class="va">geom</span><span class="op">)</span></code></pre></div>
<pre><code>## sf [18041, 4] 
## active geometry column: geom (POLYGON)
## crs: 5070 (NAD83 / Conus Albers)
## crs unit: metre 
## ID        chr cat-1 cat-2 cat-4 cat-5 cat-6 cat-7
## area_sqkm dbl 12.457576 267.083595 8.319214 9.278138 60.577~
## toID      chr nex-2 nex-3 nex-5 nex-6 nex-7 nex-8
## geom      sfc POLY 2,024B POLY 9,064B POLY 1,656B POLY 1,81~</code></pre>
<p>And the <code>soilproperties_CONUS_FullRouting</code> file from NWM v2.16. Can download from <a href="https://www.nco.ncep.noaa.gov/pmb/codes/nwprod/nwm.v2.1.6/parm/domain/soilproperties_CONUS_FullRouting.nc">here</a></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">f</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="st">'soilproperties_CONUS_FullRouting.nc'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "vobjtovarid4: **** WARNING **** I was asked to get a varid for dimension named west_east BUT this dimension HAS NO DIMVAR! Code will probably fail at this point"
## [1] "vobjtovarid4: **** WARNING **** I was asked to get a varid for dimension named south_north BUT this dimension HAS NO DIMVAR! Code will probably fail at this point"</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 3840, 4608, 45  (nrow, ncol, nlyr)
## resolution  : 1, 1  (x, y)
## extent      : 0.5, 4608, 0.5, 3840  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=longlat +datum=WGS84 +no_defs 
## sources     : soilproperties_CONUS_FullRouting.nc:bexp  (4 layers) 
##               soilproperties_CONUS_FullRouting.nc:cwpvt  
##               soilproperties_CONUS_FullRouting.nc:dksat  (4 layers) 
##               ... and 15 more source(s)
## varnames    : bexp 
##               cwpvt 
##               dksat 
##               ...
## names       : bexp_~ime=1, bexp_~ime=1, bexp_~ime=1, bexp_~ime=1, cwpvt_Time=1, dksat~ime=1, ...</code></pre>
<p>Note that when the layered attributes are separated, there are 45 raster layers. Also note that the spatial metadata for the NWM file is out of wack (see the resolution, extent, and CRS). We will fix this using some functionality from <code>wrfhydroSubsetter</code> to identify the layer structure.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">wrfhydroSubsetter</span><span class="op">)</span>
<span class="va">e</span> <span class="op">=</span> <span class="fu">make_empty_geogrid_raster</span><span class="op">(</span><span class="st">'/Volumes/Transcend/nwmCONUS-v216/geo_em_CONUS.nc'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>
<span class="va">f</span></code></pre></div>
<pre><code>## class       : SpatRaster 
## dimensions  : 3840, 4608, 45  (nrow, ncol, nlyr)
## resolution  : 1000, 1000  (x, y)
## extent      : -2304000, 2304000, -1920001, 1919999  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=lcc +lat_0=40.0000076293945 +lon_0=-97 +lat_1=30 +lat_2=60 +x_0=0 +y_0=0 +R=6370000 +units=m +no_defs 
## sources     : soilproperties_CONUS_FullRouting.nc:bexp  (4 layers) 
##               soilproperties_CONUS_FullRouting.nc:cwpvt  
##               soilproperties_CONUS_FullRouting.nc:dksat  (4 layers) 
##               ... and 15 more source(s)
## varnames    : bexp 
##               cwpvt 
##               dksat 
##               ...
## names       : bexp_~ime=1, bexp_~ime=1, bexp_~ime=1, bexp_~ime=1, cwpvt_Time=1, dksat~ime=1, ...</code></pre>
</div>
<div id="build-weight-grid" class="section level3">
<h3 class="hasAnchor">
<a href="#build-weight-grid" class="anchor"></a>Build Weight Grid</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w_time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">zonal_w</span> <span class="op">=</span> <span class="fu"><a href="../reference/weighting_grid.html">weighting_grid</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">f</span>, geom <span class="op">=</span> <span class="va">geom</span>, ID <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="fu">paint</span><span class="op">(</span><span class="va">zonal_w</span><span class="op">)</span></code></pre></div>
<pre><code>## data.table [330755, 5] 
## keys: grid_id 
## ID      chr cat-72 cat-72 cat-72 cat-72 cat-72 cat-72
## Y       dbl 689 689 689 689 689 689
## X       dbl 4310 4311 4312 4313 4314 4315
## grid_id dbl 175 176 177 178 179 180
## w       dbl 0.407517 0.360609 0.203826 0.096122 0.22353 0.0~</code></pre>
</div>
<div id="execute-intersection" class="section level3">
<h3 class="hasAnchor">
<a href="#execute-intersection" class="anchor"></a>Execute Intersection</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">z_time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">out</span> <span class="op">=</span> <span class="fu">zonal</span><span class="fu">::</span><span class="fu"><a href="../reference/execute_zonal.html">execute_zonal</a></span><span class="op">(</span><span class="va">f</span>, w <span class="op">=</span> <span class="va">zonal_w</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">'ID'</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html">names</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span>

<span class="fu">paint</span><span class="op">(</span><span class="va">out</span><span class="op">)</span></code></pre></div>
<pre><code>## data.table [18041, 46] 
## keys: ID 
## ID                               chr cat-1 cat-10 cat-100 c~
## bexp_soil_layers_stag=1_Time=1   dbl 8.282019 8.3008 4.4022~
## bexp_soil_layers_stag=2_Time=1   dbl 8.282019 8.3008 4.4022~
## bexp_soil_layers_stag=3_Time=1   dbl 8.282019 8.3008 4.4022~
## bexp_soil_layers_stag=4_Time=1   dbl 8.282019 8.3008 4.4022~
## cwpvt_Time=1                     dbl 0.358165 0.358331 0.35~
## dksat_soil_layers_stag=1_Time=1  dbl 0.000004 0.000004 0.00~
## dksat_soil_layers_stag=2_Time=1  dbl 0.000004 0.000004 0.00~
## dksat_soil_layers_stag=3_Time=1  dbl 0.000004 0.000004 0.00~
## dksat_soil_layers_stag=4_Time=1  dbl 0.000004 0.000004 0.00~
## dwsat_soil_layers_stag=1_Time=1  dbl 0.000023 0.000024 0.00~
## dwsat_soil_layers_stag=2_Time=1  dbl 0.000023 0.000024 0.00~
## dwsat_soil_layers_stag=3_Time=1  dbl 0.000023 0.000024 0.00~
## dwsat_soil_layers_stag=4_Time=1  dbl 0.000023 0.000024 0.00~
## hvt_Time=1                       dbl 16 19.315861 9.692179 ~
## mfsno_Time=1                     dbl 3.642424 3.735388 1.16~
## mp_Time=1                        dbl 12.393361 8.971084 9.9~
## psisat_soil_layers_stag=1_Time=1 dbl 0.716336 0.759 0.18949~
## psisat_soil_layers_stag=2_Time=1 dbl 0.716336 0.759 0.18949~
## psisat_soil_layers_stag=3_Time=1 dbl 0.716336 0.759 0.18949~
## psisat_soil_layers_stag=4_Time=1 dbl 0.716336 0.759 0.18949~
## quartz_soil_layers_stag=1_Time=1 dbl 0.265841 0.25 0.539492~
## quartz_soil_layers_stag=2_Time=1 dbl 0.265841 0.25 0.539492~
## quartz_soil_layers_stag=3_Time=1 dbl 0.265841 0.25 0.539492~
## quartz_soil_layers_stag=4_Time=1 dbl 0.265841 0.25 0.539492~
## refdk_Time=1                     dbl 0.000002 0.000002 0.00~
## refkdt_Time=1                    dbl 3.81326 3.861417 2.528~
## rsurfexp_Time=1                  dbl 1.191117 1.145731 2.40~
## slope_Time=1                     dbl 0.258123 0.267325 0.01~
## smcdry_soil_layers_stag=1_Time=1 dbl 0.082099 0.084 0.03394~
## smcdry_soil_layers_stag=2_Time=1 dbl 0.082099 0.084 0.03394~
## smcdry_soil_layers_stag=3_Time=1 dbl 0.082099 0.084 0.03394~
## smcdry_soil_layers_stag=4_Time=1 dbl 0.082099 0.084 0.03394~
## smcmax_soil_layers_stag=1_Time=1 dbl 0.454912 0.456694 0.69~
## smcmax_soil_layers_stag=2_Time=1 dbl 0.454912 0.456694 0.69~
## smcmax_soil_layers_stag=3_Time=1 dbl 0.454912 0.456694 0.69~
## smcmax_soil_layers_stag=4_Time=1 dbl 0.454912 0.456694 0.69~
## smcref_soil_layers_stag=1_Time=1 dbl 0.356726 0.36 0.191197~
## smcref_soil_layers_stag=2_Time=1 dbl 0.356726 0.36 0.191197~
## smcref_soil_layers_stag=3_Time=1 dbl 0.356726 0.36 0.191197~
## smcref_soil_layers_stag=4_Time=1 dbl 0.356726 0.36 0.191197~
## smcwlt_soil_layers_stag=1_Time=1 dbl 0.082099 0.084 0.03394~
## smcwlt_soil_layers_stag=2_Time=1 dbl 0.082099 0.084 0.03394~
## smcwlt_soil_layers_stag=3_Time=1 dbl 0.082099 0.084 0.03394~
## smcwlt_soil_layers_stag=4_Time=1 dbl 0.082099 0.084 0.03394~
## vcmx25_Time=1                    dbl 60.770485 51.91229 43.~</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/terra/man/hist.html">hist</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">`bexp_soil_layers_stag=1_Time=1`</span><span class="op">)</span></code></pre></div>
<p><img src="nwm-nwm-hist-1.png" title="plot of chunk nwm-hist" alt="plot of chunk nwm-hist" width="100%"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/merge.html">merge</a></span><span class="op">(</span><span class="va">geom</span>, <span class="va">out</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">f</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="nwm-nwm-map-1.png" title="plot of chunk nwm-map" alt="plot of chunk nwm-map" width="100%"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">spat</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">`bexp_soil_layers_stag=1_Time=1`</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="nwm-nwm-map-2.png" title="plot of chunk nwm-map" alt="plot of chunk nwm-map" width="100%"></p>
</div>
<div id="summary" class="section level3">
<h3 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h3>
<p><img src="nwm-nwm-summary-1.png" title="plot of chunk nwm-summary" alt="plot of chunk nwm-summary" width="100%"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Mike Johnson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
